<!doctype html>
<html>
<head>
    <title>PC - Cabine Fotogr√°fica</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        #debug { background: #000; color: #0f0; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        img { max-width: 200px; margin: 5px; border: 2px solid #0f0; }
        .status-connected { color: #0f0; }
        .status-disconnected { color: #f00; }
        button { padding: 10px; margin: 5px; background: #333; color: white; border: 1px solid #666; }
    </style>
</head>
<body>
    <h1>üì∏ Cabine Fotogr√°fica - PC</h1>
    <div>Status: <span id="status" class="status-disconnected">Desconectado</span></div>
    <div>Sess√£o: <code id="sessionId"></code></div>
    
    <button onclick="generateQR()">üîó Gerar QR Code</button>
    <button onclick="clearDebug()">üóëÔ∏è Limpar Logs</button>
    
    <div id="qrDiv"></div>
    <div id="debug"></div>
    <div id="photos"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script>
        const SERVER_URL = "https://render-9ea7.onrender.com";
        const sessionId = 'pc_' + Date.now();
        
        document.getElementById('sessionId').textContent = sessionId;
        
        // ‚úÖ CONFIGURA√á√ÉO ROBUSTA DO SOCKET
        const socket = io(SERVER_URL, {
            transports: ['websocket', 'polling'],
            timeout: 10000,
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000
        });
        
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#fff';
            console.log(`PC [${timestamp}]:`, msg);
            
            const debug = document.getElementById('debug');
            debug.innerHTML = `<span style="color: ${color}">[${timestamp}] ${msg}</span><br>` + debug.innerHTML;
        }

        // ‚úÖ EVENTOS DO SOCKET
        socket.on('connect', () => {
            log('‚úÖ CONECTADO - Socket: ' + socket.id, 'success');
            document.getElementById('status').textContent = 'Conectado';
            document.getElementById('status').className = 'status-connected';
            
            // Entrar na sala
            socket.emit('join_room', { session: sessionId });
            log('üö™ Entrando na sala: ' + sessionId);
        });

        socket.on('photos_from_cell', (data) => {
            log('üéâ FOTOS RECEBIDAS! ' + data.photos.length + ' fotos', 'success');
            log('Sess√£o: ' + data.session);
            
            // Mostrar as fotos
            const photosDiv = document.getElementById('photos');
            photosDiv.innerHTML = '<h3>üì∏ Fotos Recebidas:</h3>';
            
            data.photos.forEach((photo, index) => {
                const img = document.createElement('img');
                img.src = photo;
                img.alt = `Foto ${index + 1}`;
                img.title = `Foto ${index + 1}`;
                photosDiv.appendChild(img);
            });
        });

        socket.on('disconnect', (reason) => {
            log('‚ùå DESCONECTADO - Raz√£o: ' + reason, 'error');
            document.getElementById('status').textContent = 'Desconectado';
            document.getElementById('status').className = 'status-disconnected';
        });

        socket.on('connect_error', (error) => {
            log('üí• ERRO DE CONEX√ÉO: ' + error.message, 'error');
        });

        socket.on('reconnect', (attempt) => {
            log('üîÅ RECONECTADO - Tentativa: ' + attempt, 'success');
            socket.emit('join_room', { session: sessionId });
        });

        function generateQR() {
            const url = window.location.origin + '/celular.html?session=' + sessionId;
            log('üîó Gerando QR Code para: ' + url);
            
            document.getElementById('qrDiv').innerHTML = '<h3>üì± QR Code para Celular:</h3>';
            
            QRCode.toCanvas(url, { width: 200, margin: 2 }, (err, canvas) => {
                if (err) {
                    log('‚ùå Erro ao gerar QR: ' + err, 'error');
                    return;
                }
                document.getElementById('qrDiv').appendChild(canvas);
                
                const link = document.createElement('p');
                link.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
                document.getElementById('qrDiv').appendChild(link);
                
                log('‚úÖ QR Code gerado com sucesso', 'success');
            });
        }

        function clearDebug() {
            document.getElementById('debug').innerHTML = '';
        }

        // Inicializa√ß√£o
        log('üéÆ PC inicializado - Sess√£o: ' + sessionId);
        log('üîó Conectando em: ' + SERVER_URL);
    </script>
</body>
</html>
