<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cabine — Celular</title>
<style>
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial, sans-serif;overflow:hidden;}
  
  /* Tela de Boas-Vindas */
  #welcomeScreen{
    position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
    z-index:10003;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);
  }
  
  #welcomeScreen h1{
    font-size:2em;margin-bottom:30px;text-align:center;text-shadow:0 4px 8px rgba(0,0,0,0.5);
    color:#fff;padding:0 20px;
  }
  
  #fullscreenBtn, #welcomeStartBtn{
    padding:15px 30px;font-size:1.2em;border-radius:15px;border:none;
    background:linear-gradient(45deg,#ff6b6b,#4ecdc4);color:white;font-weight:bold;
    cursor:pointer;margin:10px;transition:transform 0.3s, box-shadow 0.3s;
    box-shadow:0 8px 20px rgba(0,0,0,0.3);
  }
  
  #fullscreenBtn:hover, #welcomeStartBtn:hover{
    transform:translateY(-3px);box-shadow:0 12px 25px rgba(0,0,0,0.4);
  }
  
  /* Elementos da sessão de fotos */
  video{
    position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;background:#000;
    transform:scaleX(-1); /* Espelha a camera */
  }
  
  #countdown{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;
    pointer-events:none;color:#fff;text-shadow:0 6px 18px rgba(0,0,0,0.8);
    font-weight:900;font-family:'Arial Black', Arial, sans-serif;font-size:120px;
  }
  
  #freezePreview{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10000;
    background:rgba(0,0,0,0.95);
  }
  
  #freezePreview img{
    max-width:90%;max-height:90%;display:block;margin:auto;border-radius:20px;
    box-shadow:0 0 50px rgba(255,255,255,0.3);
    transform:scaleX(-1); /* Espelha a foto para combinar com a camera */
  }
  
  #thankOverlay{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10002;
    background:linear-gradient(135deg,#000000dd,#1a1a2edd);color:#fff;font-size:2em;
    font-weight:700;text-align:center;flex-direction:column;
  }
  
  #restartBtn{
    padding:15px 30px;font-size:0.6em;border-radius:10px;border:none;background:#4ecdc4;
    color:white;font-weight:bold;cursor:pointer;margin-top:30px;
  }
  
  .hidden{display:none !important;}
  .visible{display:flex !important;}
</style>
</head>
<body>
<!-- Tela de Boas-Vindas -->
<div id="welcomeScreen" class="visible">
  <h1>📸 Bem-vindo à Cabine Fotográfica! 📸</h1>
  <button id="fullscreenBtn">🎯 Entrar em Tela Cheia</button>
  <button id="welcomeStartBtn" class="hidden">🚀 Clique aqui para iniciar</button>
</div>

<!-- Sessão de Fotos -->
<video id="preview" autoplay playsinline muted class="hidden"></video>
<div id="countdown" class="hidden"></div>
<div id="freezePreview" class="hidden"><img id="freezeImg" src=""></div>
<audio id="shutterAudio" preload="auto">
  <source src="clack.mp3" type="audio/mpeg">
</audio>
<div id="thankOverlay" class="hidden">
  <div>🎉 Obrigado por usar a cabine! 🎉</div>
  <button id="restartBtn">🔄 Iniciar Nova Sessão</button>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
(async function(){
  const SERVER = "https://render-9ea7.onrender.com";
  
  // Obter session da URL ou criar uma
  const urlParams = new URLSearchParams(window.location.search);
  const session = urlParams.get('session') || 'cell_' + Date.now();
  
  const socket = io(SERVER, { 
    transports: ['websocket', 'polling'],
    withCredentials: true
  });
  
  const preview = document.getElementById('preview');
  const countdownEl = document.getElementById('countdown');
  const freezeDiv = document.getElementById('freezePreview');
  const freezeImg = document.getElementById('freezeImg');
  const welcomeScreen = document.getElementById('welcomeScreen');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const welcomeStartBtn = document.getElementById('welcomeStartBtn');
  const thankOverlay = document.getElementById('thankOverlay');
  const restartBtn = document.getElementById('restartBtn');
  const shutter = document.getElementById('shutterAudio');
  
  let localStream = null;
  let photos = [];
  let isFullscreen = false;
  
  function delay(ms){ return new Promise(r=>setTimeout(r, ms)); }
  
  // Função para tela cheia
  function enterFullscreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
      elem.requestFullscreen().catch(err => {
        console.log('Fullscreen error:', err);
      });
    } else if (elem.webkitRequestFullscreen) {
      elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) {
      elem.msRequestFullscreen();
    }
  }
  
  // Event listener para mudanças no fullscreen
  document.addEventListener('fullscreenchange', handleFullscreenChange);
  document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
  
  function handleFullscreenChange() {
    isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
    console.log('Fullscreen changed:', isFullscreen);
    
    if (isFullscreen) {
      fullscreenBtn.style.display = 'none';
      welcomeStartBtn.style.display = 'block';
      welcomeStartBtn.classList.remove('hidden');
    }
  }
  
  function showCountdownText(txt, sizePx){ 
    countdownEl.textContent = txt; 
    countdownEl.style.fontSize = sizePx + 'px'; 
    countdownEl.style.display = 'flex'; 
  }
  
  function hideCountdown(){ 
    countdownEl.style.display = 'none'; 
  }
  
  async function startCamera(){
    try{
      localStream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'user',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }, 
        audio: false 
      });
      preview.srcObject = localStream;
      console.log("Camera started successfully");
    }catch(e){
      console.error("Camera error", e);
      alert("Erro ao acessar câmera: " + e.message);
    }
  }
  
  async function countdown(seconds){
    console.log(`Starting countdown: ${seconds} seconds`);
    for(let n=seconds; n>=1; n--){
      showCountdownText(String(n), 120);
      await delay(1000);
    }
    showCountdownText('SORRIA! 😄', 80);
    try{ 
      if(shutter) {
        shutter.currentTime = 0; 
        shutter.play().catch(e => console.log('Audio error:', e)); 
      }
    }catch(e){}
    await delay(2000);
    hideCountdown();
  }
  
  async function captureFrame(){
    const w = preview.videoWidth || 1280;
    const h = preview.videoHeight || 720;
    const c = document.createElement('canvas'); 
    c.width = w; 
    c.height = h;
    const ctx = c.getContext('2d'); 
    // Espelha a imagem para combinar com a preview da camera
    ctx.translate(w, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(preview, 0, 0, w, h);
    return c.toDataURL('image/jpeg', 0.95);
  }
  
  async function runSequence(){
    console.log('Starting photo sequence...');
    photos = [];
    
    // Esconder tela de boas-vindas e mostrar camera
    welcomeScreen.style.display = 'none';
    preview.style.display = 'block';
    
    for(let i=1;i<=3;i++){
      console.log(`📸 Foto ${i} iniciando...`);
      await countdown(3); // Reduzido para 3 segundos para teste
      
      const data = await captureFrame();
      photos.push(data);
      console.log(`✅ Foto ${i} capturada`);
      
      // Mostrar a foto capturada por 3 segundos
      freezeImg.src = data;
      freezeDiv.style.display = 'flex';
      
      await delay(3000);
      freezeDiv.style.display = 'none';
      
      if(i < 3) {
        await delay(1000); // Pequena pausa entre fotos
      }
    }
    
    // Enviar fotos para o servidor
    console.log('📤 Enviando fotos para servidor...', { 
      session: session, 
      photoCount: photos.length,
      photos: photos.map((p, i) => `Foto ${i+1}: ${p.substring(0, 50)}...`)
    });
    
    socket.emit('photos_from_cell', { session, photos });
    
    // Mostrar agradecimento
    thankOverlay.style.display = 'flex';
    console.log('🎉 Mostrando tela de agradecimento');
  }
  
  // Event Listeners
  fullscreenBtn.addEventListener('click', enterFullscreen);
  
  welcomeStartBtn.addEventListener('click', async ()=>{ 
    console.log('Start button clicked');
    try {
      await startCamera();
      // Pequeno delay para garantir que a camera está rodando
      await delay(1000);
      runSequence().catch(e=>{
        console.error('Erro na sequência:', e);
        alert('Erro ao iniciar sessão: ' + e.message);
      }); 
    } catch (error) {
      console.error('Error starting:', error);
    }
  });
  
  restartBtn.addEventListener('click', ()=>{ 
    console.log('Restart button clicked');
    thankOverlay.style.display = 'none';
    preview.style.display = 'none';
    welcomeScreen.style.display = 'flex';
    photos = [];
    
    // Parar camera
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
    }
  });
  
  socket.on('finalize_session', (d)=>{ 
    console.log('Finalize session received:', d);
    thankOverlay.style.display = 'none';
    preview.style.display = 'none';
    welcomeScreen.style.display = 'flex';
    photos = [];
    
    // Parar camera
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
    }
  });
  
  socket.on('connect', ()=>{ 
    console.log('✅ Connected to server');
    socket.emit('join_room', { session }); 
    console.log('Joined room:', session); 
  });
  
  socket.on('disconnect', ()=>{ 
    console.log('❌ Disconnected from server');
  });
  
  // Debug do socket
  socket.on('photos_from_cell', (data)=>{
    console.log('🔔 DEBUG - photos_from_cell received on cell (unexpected):', data);
  });
  
  console.log('📱 Celular inicializado com session:', session);
  
})();
</script>
</body>
</html>
