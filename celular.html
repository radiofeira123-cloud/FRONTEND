<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cabine ‚Äî Celular</title>
<style>
  * {
    box-sizing: border-box;
  }
  
  html,body{
    height:100%;margin:0;background:#000;color:#fff;
    font-family:Arial, sans-serif;overflow:hidden;
  }
  
  /* Tela de Boas-Vindas */
  #welcomeScreen{
    position:fixed;inset:0;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    z-index:10003;
    background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);
    padding:20px;
  }
  
  #welcomeScreen h1{
    font-size:1.8em;margin-bottom:30px;text-align:center;
    color:#fff;padding:0 10px;line-height:1.3;
  }
  
  #fullscreenBtn, #welcomeStartBtn{
    padding:15px 25px;font-size:1.1em;border-radius:12px;border:none;
    background:linear-gradient(45deg,#ff6b6b,#4ecdc4);color:white;font-weight:bold;
    cursor:pointer;margin:10px;width:80%;max-width:300px;
  }
  
  /* Sess√£o de Fotos - CORRIGIDO */
  #cameraScreen{
    position:fixed;inset:0;z-index:1;background:#000;
    display:none; /* Come√ßa escondido */
  }
  
  video{
    width:100%;height:100%;object-fit:cover;
    transform:scaleX(-1); /* Espelha a camera */
  }
  
  #countdown{
    position:fixed;inset:0;
    display:none;align-items:center;justify-content:center;
    z-index:9999;pointer-events:none;
    color:#fff;text-shadow:0 6px 18px rgba(0,0,0,0.8);
    font-weight:900;font-family:'Arial Black', Arial, sans-serif;
    font-size:100px;
  }
  
  #freezePreview{
    position:fixed;inset:0;
    display:none;align-items:center;justify-content:center;
    z-index:10000;background:rgba(0,0,0,0.95);
  }
  
  #freezePreview img{
    max-width:95%;max-height:95%;border-radius:15px;
    box-shadow:0 0 50px rgba(255,255,255,0.3);
    transform:scaleX(-1); /* Espelha a foto */
  }
  
  #thankOverlay{
    position:fixed;inset:0;
    display:none;align-items:center;justify-content:center;
    z-index:10002;background:rgba(0,0,0,0.9);
    color:#fff;font-size:1.8em;text-align:center;
    flex-direction:column;padding:20px;
  }
  
  #restartBtn{
    padding:12px 24px;font-size:0.7em;border-radius:10px;
    border:none;background:#4ecdc4;color:white;
    font-weight:bold;cursor:pointer;margin-top:30px;
  }
  
  .hidden{display:none !important;}
  .visible{display:flex !important;}
</style>
</head>
<body>
<!-- Tela de Boas-Vindas -->
<div id="welcomeScreen" class="visible">
  <h1>üì∏ Bem-vindo √† Cabine Fotogr√°fica! üì∏</h1>
  <button id="fullscreenBtn">üéØ Entrar em Tela Cheia</button>
  <button id="welcomeStartBtn" class="hidden">üöÄ Clique aqui para iniciar</button>
</div>

<!-- Sess√£o de Fotos -->
<div id="cameraScreen" class="hidden">
  <video id="preview" autoplay playsinline muted></video>
  <div id="countdown" class="hidden"></div>
  <div id="freezePreview" class="hidden">
    <img id="freezeImg" src="" alt="Foto capturada">
  </div>
</div>

<audio id="shutterAudio" preload="auto">
  <source src="clack.mp3" type="audio/mpeg">
</audio>

<div id="thankOverlay" class="hidden">
  <div>üéâ Obrigado por usar a cabine! üéâ</div>
  <button id="restartBtn">üîÑ Iniciar Nova Sess√£o</button>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
(async function(){
  const SERVER = "https://render-9ea7.onrender.com";
  
  // Obter session da URL
  const urlParams = new URLSearchParams(window.location.search);
  const session = urlParams.get('session') || 'cell_' + Date.now();
  
  const socket = io(SERVER, { 
    transports: ['websocket', 'polling'],
    withCredentials: true
  });
  
  // Elementos
  const welcomeScreen = document.getElementById('welcomeScreen');
  const cameraScreen = document.getElementById('cameraScreen');
  const preview = document.getElementById('preview');
  const countdownEl = document.getElementById('countdown');
  const freezeDiv = document.getElementById('freezePreview');
  const freezeImg = document.getElementById('freezeImg');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const welcomeStartBtn = document.getElementById('welcomeStartBtn');
  const thankOverlay = document.getElementById('thankOverlay');
  const restartBtn = document.getElementById('restartBtn');
  const shutter = document.getElementById('shutterAudio');
  
  let localStream = null;
  let photos = [];
  
  function delay(ms){ return new Promise(r=>setTimeout(r, ms)); }
  
  // Fun√ß√£o para tela cheia
  function enterFullscreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
      elem.requestFullscreen().catch(err => {
        console.log('Fullscreen error:', err);
      });
    }
  }
  
  // Event listener para fullscreen
  document.addEventListener('fullscreenchange', function() {
    const isFullscreen = !!document.fullscreenElement;
    console.log('Fullscreen changed:', isFullscreen);
    
    if (isFullscreen) {
      fullscreenBtn.style.display = 'none';
      welcomeStartBtn.classList.remove('hidden');
    }
  });
  
  function showCountdownText(txt, sizePx){ 
    countdownEl.textContent = txt; 
    countdownEl.style.fontSize = sizePx + 'px'; 
    countdownEl.style.display = 'flex'; 
  }
  
  function hideCountdown(){ 
    countdownEl.style.display = 'none'; 
  }
  
  async function startCamera(){
    try{
      localStream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'user',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }, 
        audio: false 
      });
      preview.srcObject = localStream;
      console.log("‚úÖ Camera started successfully");
      return true;
    }catch(e){
      console.error("‚ùå Camera error", e);
      alert("Erro ao acessar c√¢mera. Por favor, permita o acesso √† c√¢mera.");
      return false;
    }
  }
  
  async function countdown(seconds){
    console.log(`üî¢ Starting countdown: ${seconds} seconds`);
    for(let n=seconds; n>=1; n--){
      showCountdownText(String(n), 120);
      await delay(1000);
    }
    showCountdownText('SORRIA! üòÑ', 80);
    try{ 
      if(shutter) {
        shutter.currentTime = 0; 
        await shutter.play(); 
      }
    }catch(e){}
    await delay(2000);
    hideCountdown();
  }
  
  async function captureFrame(){
    const w = preview.videoWidth || 1280;
    const h = preview.videoHeight || 720;
    const c = document.createElement('canvas'); 
    c.width = w; 
    c.height = h;
    const ctx = c.getContext('2d'); 
    ctx.translate(w, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(preview, 0, 0, w, h);
    return c.toDataURL('image/jpeg', 0.95);
  }
  
  async function runSequence(){
    console.log('üé¨ Starting photo sequence...');
    photos = [];
    
    // MOSTRAR CAMERA E ESCONDER WELCOME
    welcomeScreen.classList.add('hidden');
    welcomeScreen.style.display = 'none';
    
    cameraScreen.classList.remove('hidden');
    cameraScreen.style.display = 'block';
    
    await delay(500); // Pequeno delay para transi√ß√£o
    
    for(let i=1;i<=3;i++){
      console.log(`üì∏ Foto ${i} iniciando...`);
      await countdown(3);
      
      const data = await captureFrame();
      photos.push(data);
      console.log(`‚úÖ Foto ${i} capturada`);
      
      // Mostrar a foto capturada
      freezeImg.src = data;
      freezeDiv.style.display = 'flex';
      
      await delay(3000);
      freezeDiv.style.display = 'none';
      
      if(i < 3) {
        await delay(1000);
      }
    }
    
    // Enviar fotos para o servidor
    console.log('üì§ Enviando fotos para servidor...', { 
      session: session, 
      photoCount: photos.length
    });
    
    socket.emit('photos_from_cell', { session, photos });
    
    // Mostrar agradecimento
    cameraScreen.style.display = 'none';
    thankOverlay.style.display = 'flex';
    console.log('üéâ Mostrando tela de agradecimento');
  }
  
  // Event Listeners
  fullscreenBtn.addEventListener('click', enterFullscreen);
  
  welcomeStartBtn.addEventListener('click', async ()=>{ 
    console.log('üéØ Start button clicked');
    const cameraStarted = await startCamera();
    
    if (cameraStarted) {
      await delay(1000); // Garantir que a camera est√° rodando
      runSequence().catch(e=>{
        console.error('‚ùå Erro na sequ√™ncia:', e);
        alert('Erro: ' + e.message);
      }); 
    }
  });
  
  restartBtn.addEventListener('click', ()=>{ 
    console.log('üîÑ Restart button clicked');
    thankOverlay.style.display = 'none';
    cameraScreen.style.display = 'none';
    welcomeScreen.style.display = 'flex';
    photos = [];
    
    // Parar camera
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
    }
  });
  
  socket.on('finalize_session', (d)=>{ 
    console.log('üõë Finalize session received');
    thankOverlay.style.display = 'none';
    cameraScreen.style.display = 'none';
    welcomeScreen.style.display = 'flex';
    photos = [];
    
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
    }
  });
  
  socket.on('connect', ()=>{ 
    console.log('‚úÖ Connected to server');
    socket.emit('join_room', { session }); 
    console.log('üö™ Joined room:', session); 
  });
  
  socket.on('disconnect', ()=>{ 
    console.log('‚ùå Disconnected from server');
  });
  
  console.log('üì± Celular inicializado com session:', session);
  
})();
</script>
</body>
</html>
