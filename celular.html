<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cabine â€” Celular</title>
<style>
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial, sans-serif;overflow:hidden;}
  
  /* Tela de Boas-Vindas */
  #welcomeScreen{
    position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
    z-index:10003;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);
    background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1200"><rect width="1200" height="1200" fill="%230f3460"/><circle cx="200" cy="200" r="80" fill="%231a1a2e" opacity="0.3"/><circle cx="800" cy="400" r="120" fill="%2316213e" opacity="0.2"/><circle cx="1000" cy="800" r="150" fill="%231a1a2e" opacity="0.3"/></svg>');
  }
  
  #welcomeScreen h1{
    font-size:2.5em;margin-bottom:30px;text-align:center;text-shadow:0 4px 8px rgba(0,0,0,0.5);
    background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  }
  
  #fullscreenBtn, #startBtn{
    padding:20px 40px;font-size:1.5em;border-radius:15px;border:none;
    background:linear-gradient(45deg,#ff6b6b,#4ecdc4);color:white;font-weight:bold;
    cursor:pointer;margin:10px;transition:transform 0.3s, box-shadow 0.3s;
    box-shadow:0 8px 20px rgba(0,0,0,0.3);
  }
  
  #fullscreenBtn:hover, #startBtn:hover{
    transform:translateY(-3px);box-shadow:0 12px 25px rgba(0,0,0,0.4);
  }
  
  /* Elementos da sessÃ£o de fotos */
  video{
    position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;background:#000;
    transform:scaleX(-1); /* Espelha a camera */
  }
  
  #countdown{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;
    pointer-events:none;color:#fff;text-shadow:0 6px 18px rgba(0,0,0,0.8);
    font-weight:900;font-family:'Arial Black', Arial, sans-serif;font-size:120px;
  }
  
  #freezePreview{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10000;
    background:rgba(0,0,0,0.95);
  }
  
  #freezePreview img{
    max-width:90%;max-height:90%;display:block;margin:auto;border-radius:20px;
    box-shadow:0 0 50px rgba(255,255,255,0.3);
    transform:scaleX(-1); /* Espelha a foto para combinar com a camera */
  }
  
  #thankOverlay{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10002;
    background:linear-gradient(135deg,#000000dd,#1a1a2edd);color:#fff;font-size:2.5em;
    font-weight:700;text-align:center;flex-direction:column;
  }
  
  #restartBtn{
    padding:15px 30px;font-size:0.6em;border-radius:10px;border:none;background:#4ecdc4;
    color:white;font-weight:bold;cursor:pointer;margin-top:30px;
  }
  
  .hidden{display:none !important;}
  .visible{display:flex !important;}
</style>
</head>
<body>
<!-- Tela de Boas-Vindas -->
<div id="welcomeScreen" class="visible">
  <h1>ðŸ“¸ Bem-vindo Ã  Cabine FotogrÃ¡fica! ðŸ“¸</h1>
  <button id="fullscreenBtn">ðŸŽ¯ Entrar em Tela Cheia</button>
  <button id="welcomeStartBtn" class="hidden">ðŸš€ Clique aqui para iniciar</button>
</div>

<!-- SessÃ£o de Fotos -->
<video id="preview" autoplay playsinline muted class="hidden"></video>
<div id="countdown" class="hidden"></div>
<div id="freezePreview" class="hidden"><img id="freezeImg" src=""></div>
<audio id="shutterAudio" src="clack.mp3" preload="auto"></audio>
<div id="thankOverlay" class="hidden">
  <div>ðŸŽ‰ Obrigado por usar a cabine! ðŸŽ‰</div>
  <button id="restartBtn">ðŸ”„ Iniciar Nova SessÃ£o</button>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
(async function(){
  const SERVER = "https://render-9ea7.onrender.com";
  
  // Obter session da URL ou criar uma
  const urlParams = new URLSearchParams(window.location.search);
  const session = urlParams.get('session') || 'cell_' + Date.now();
  
  const socket = io(SERVER, { transports: ['websocket','polling'] });
  const preview = document.getElementById('preview');
  const countdownEl = document.getElementById('countdown');
  const freezeDiv = document.getElementById('freezePreview');
  const freezeImg = document.getElementById('freezeImg');
  const welcomeScreen = document.getElementById('welcomeScreen');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const welcomeStartBtn = document.getElementById('welcomeStartBtn');
  const thankOverlay = document.getElementById('thankOverlay');
  const restartBtn = document.getElementById('restartBtn');
  const shutter = document.getElementById('shutterAudio');
  
  let localStream = null;
  let photos = [];
  let isFullscreen = false;
  
  function delay(ms){ return new Promise(r=>setTimeout(r, ms)); }
  
  // FunÃ§Ã£o para tela cheia
  function enterFullscreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
      elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) {
      elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) {
      elem.msRequestFullscreen();
    }
    isFullscreen = true;
  }
  
  // Event listener para mudanÃ§as no fullscreen
  document.addEventListener('fullscreenchange', handleFullscreenChange);
  document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
  
  function handleFullscreenChange() {
    isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
    if (isFullscreen) {
      fullscreenBtn.classList.add('hidden');
      welcomeStartBtn.classList.remove('hidden');
    }
  }
  
  function showCountdownText(txt, sizePx){ 
    countdownEl.textContent = txt; 
    countdownEl.style.fontSize = sizePx + 'px'; 
    countdownEl.classList.remove('hidden'); 
  }
  
  function hideCountdown(){ 
    countdownEl.classList.add('hidden'); 
  }
  
  async function startCamera(){
    try{
      localStream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'user',
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }, 
        audio: false 
      });
      preview.srcObject = localStream;
      await preview.play().catch(()=>{});
      console.log("Camera started");
    }catch(e){
      console.error("Camera error", e);
      alert("Erro ao acessar cÃ¢mera: " + e.message);
    }
  }
  
  async function countdown(seconds){
    for(let n=seconds; n>=1; n--){
      showCountdownText(String(n), Math.max(120, Math.floor(window.innerWidth/4)));
      await delay(1000);
    }
    showCountdownText('SORRIA! ðŸ˜„', Math.max(80, Math.floor(window.innerWidth/6)));
    try{ 
      shutter.currentTime = 0; 
      shutter.play().catch(()=>{}); 
    }catch(e){}
    await delay(2000);
    hideCountdown();
  }
  
  async function captureFrame(){
    const w = preview.videoWidth || 1280;
    const h = preview.videoHeight || 720;
    const c = document.createElement('canvas'); 
    c.width = w; 
    c.height = h;
    const ctx = c.getContext('2d'); 
    // Espelha a imagem para combinar com a preview da camera
    ctx.translate(w, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(preview, 0, 0, w, h);
    return c.toDataURL('image/jpeg', 0.95);
  }
  
  async function runSequence(){
    photos = [];
    welcomeScreen.classList.add('hidden');
    preview.classList.remove('hidden');
    
    for(let i=1;i<=3;i++){
      console.log(`Foto ${i} iniciando...`);
      await countdown(5);
      
      const data = await captureFrame();
      photos.push(data);
      console.log(`Foto ${i} capturada`);
      
      // Mostrar a foto capturada por 3 segundos
      freezeImg.src = data;
      freezeDiv.classList.remove('hidden');
      
      await delay(3000);
      freezeDiv.classList.add('hidden');
      
      if(i < 3) {
        await delay(500); // Pequena pausa entre fotos
      }
    }
    
    // Enviar fotos para o servidor
    console.log('Enviando fotos para servidor...', { session, photoCount: photos.length });
    socket.emit('photos_from_cell', { session, photos });
    
    // Mostrar agradecimento
    thankOverlay.classList.remove('hidden');
  }
  
  // Event Listeners
  fullscreenBtn.addEventListener('click', enterFullscreen);
  
  welcomeStartBtn.addEventListener('click', async ()=>{ 
    await startCamera();
    runSequence().catch(e=>{
      console.error('Erro na sequÃªncia:', e);
      alert('Erro ao iniciar sessÃ£o: ' + e.message);
    }); 
  });
  
  restartBtn.addEventListener('click', ()=>{ 
    thankOverlay.classList.add('hidden');
    preview.classList.add('hidden');
    welcomeScreen.classList.remove('hidden');
    photos = [];
  });
  
  socket.on('finalize_session', (d)=>{ 
    console.log('Finalize session received:', d);
    if(d && d.session){ 
      thankOverlay.classList.add('hidden');
      preview.classList.add('hidden');
      welcomeScreen.classList.remove('hidden');
      photos = []; 
    } 
  });
  
  socket.on('connect', ()=>{ 
    socket.emit('join_room', { session }); 
    console.log('Connected to server (cell), room:', session); 
  });
  
  socket.on('disconnect', ()=>{ 
    console.log('Disconnected from server');
  });
  
  // Debug: log de eventos de photos_from_cell
  socket.on('photos_from_cell', (data)=>{
    console.log('DEBUG - photos_from_cell received (should not happen on cell):', data);
  });
  
})();
</script>
</body>
</html>
